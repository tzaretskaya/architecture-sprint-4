Мотивация
- улучшение видимости и повышение безопасности системы. Видимость означает, что вы можете получить полное представление о работе системы. Чем выше видимость, тем проще обеспечить безопасность.
- Более быстрое решение проблем и повышение надёжности системы. С помощью инструментов наблюдения команда может быстрее определить корень проблемы.
- Повышение удовлетворённости пользователей. Своевременное решение проблем, которые связаны с производительностью и функциональностью приложения, улучшает пользовательский опыт.

Выбор подхода к мониторингу:
- USE для всего железа, бд, очереди, s3
- RED для сервисов

Метрики:
1. Number of dead-letter-exchange letters in RabbitMQ

Что это: количество сообщений, попавших в Dead Letter Queue (DLQ), потому что они не были обработаны
Критический показатель: быстрое и значительное увеличение
Что делать:
    •    Проанализировать причину: неверный формат сообщений, истёкший TTL или переполненная очередь
    •    Увеличить TTL, пересмотреть логику обработки или оптимизировать Consumer

2. Number of messages in flight in RabbitMQ

Что это: количество сообщений, которые RabbitMQ отправил, но не получил подтверждение от Consumer
Критический показатель: увеличение при нормальной работе Consumer указывает на проблемы.
Что делать:
    •    Проверить производительность Consumer
    •    Увеличить число Consumers или оптимизировать их обработку

3. Number of requests (RPS) for API, ярлык по ноде, паттерну ендпоинта, методу:

Что это: количество запросов в секунду к API
Критический показатель: зависит от пропускной способности API, резкий рост может указывать на DDoS
Что делать:
    •    Включить rate-limiting
    •    Масштабировать API (добавить инстансы)

4. Number of requests (RPS) per user for API, ярлык по ноде, паттерну ендпоинта, методу:

Что это: запросы в секунду, отправляемые одним пользователем
Критический показатель: высокая активность одного пользователя может быть подозрительной
Что делать:
    •    Настроить rate-limiting для пользователей

5. CPU % for API, ярлык по хосту:

Что это: загруженность процессора инстансов API
Критический показатель: более 80–90% длительное время
Что делать:
    •    Добавить больше CPU или горизонтально масштабировать инстансы
    •    Оптимизировать код

6. Memory Utilization for API, ярлык по ноде:

Что это: использование оперативной памяти API
Критический показатель: постоянное превышение 80–90%
Что делать:
    •    Увеличить доступную память
    •    Оптимизировать использование памяти (например, снизить объём кеша)

7. Memory Utilization for DB instance, ярлык по ноде:

Что это: потребление оперативной памяти базой данных
Критический показатель: 80–90%
Что делать:
    •    Проверить настройки кеширования и оптимизировать запросы
    •    Увеличить объём памяти

8. Number of connections for DB instance, ярлык по ноде:

Что это: количество активных подключений к базе данных
Критический показатель: близость к максимальному лимиту подключения (например, 1000 для PostgreSQL по умолчанию)
Что делать:
    •    Настроить пул соединений (например, pgBouncer)
    •    Оптимизировать приложение, чтобы уменьшить количество соединений

9. Response time (latency) for API, ярлык по ноде, паттерну ендпоинта, методу и коду ответа:

Что это: среднее время ответа API
Критический показатель: зависит от SLA, например, >100 мс
Что делать:
    •    Оптимизировать обработку запросов
    •    Масштабировать API или внедрить кэширование

10. Size of S3 storage, ярлык по ноде:

Что это: объём данных, хранящихся в S3
Критический показатель: увеличение стоимости из-за превышения лимитов хранения
Что делать:
    •    Оптимизировать хранение данных (архивирование, удаление старых файлов)

11. Size of DB instance, ярлык по ноде:

Что это: размер хранилища, используемого базой данных
Критический показатель: 80–90% доступного объёма
Что делать:
    • Увеличить объём хранилища
    • Архивировать или удалять старые данные

12. Number of HTTP 200 for API, ярлык по ноде, паттерну ендпоинта, методу:

Что это: количество успешных запросов
Критический показатель: уменьшение может указывать на сбои
Что делать:
    •    Диагностировать API и устранить проблему

13. Number of HTTP 500 for API, ярлык по ноде, паттерну ендпоинта, методу:

Что это: количество ошибок на стороне сервера
Критический показатель: увеличение
Что делать:
    •    Логировать и исправить причину ошибок

14. Number of simultaneous sessions for API, ярлык по ноде:

Что это: количество одновременных сеансов API
Критический показатель: близость к лимиту пропускной способности API
Что делать:
    •    Масштабировать API

15. KB transferred (received) for API, ярлык по ноде:

Что это: количество данных, принятых API
Критический показатель: резкий рост может указывать на аномальную активность
Что делать:
    •    Настроить rate-limiting или мониторить загрузку

16. KB provided (sent) for API, ярлык по ноде:

Что это: количество данных, отправленных API
Критический показатель: увеличение может перегрузить сеть
Что делать:
    •    Оптимизировать формат данных или использовать сжатие

17. HDD/SSD utilization for API, ярлык по ноде
Что это: использование HDD памяти API
Критический показатель: постоянное превышение 80–90%
Что делать:
    •    Увеличить доступную память
    •    Оптимизировать использование памяти

18. Number of incoming and outgoing messages in RabbitMQ, ярлык по ноде
19. Number of Publishers and Consumers in RabbitMQ, ярлык по ноде
20. Number of connections, queues, nodes in RabbitMQ, ярлык по ноде
21. Disk space available for RabbitMQ, ярлык по ноде
22. Number of messages published, delivered, acknowledged in RabbitMQ, ярлык по ноде
23. Number of active sessions in db, ярлык по ноде
24. Number of transactions in db, ярлык по ноде и по клиенту
25. lock tables in db
26. S3 API request rate, ярлык по ноде
27. S3 API request 4xx error rate, ярлык по ноде
28. S3 API request 500 error rate, ярлык по ноде
29. S3 number of buckets


План действий:
- Поднять Prometheus
- Добавить в сервисы метрики, которые будет вытягивать Prometheus
- Поднять Graphana
- Добавить в Graphana dashboards, на которых строим графики по метрикам из Prometheus а также из бд

